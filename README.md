# Знакомство с REST API на примере сервиса Cats

Цель: познакомиться с основами REST API и научиться работать с контроллерами, DTO, обработкой ошибок и статусами HTTP в приложении на NestJS.

## Описание

Проект использует приложение на базе NestJS с использованием PostgreSQL в качестве базы данных. Для локальной разработки используется Docker и Docker Compose.

## Задание:

1. Реализуйте корректную обработку случая, когда кошка с заданным id не найдена:
    + При запросе `GET /cats/:id` и `DELETE /cats/:id` должна возвращаться ошибка 404 Not Found.
    + Тело ответа должно содержать сообщение:
`{ "statusCode": 404, "message": "Кошка с id=X не найдена" }`.

2. При создании новой кошки `(POST /cats)` реализуйте проверку на уникальность по комбинации `name, age, breed`.
    + В случае конфликта верните: Статус: `409 Conflict`. Сообщение: `{ "statusCode": 409, "message": "Такая кошка уже существует" }`.

3. Добавьте метод обновления данных `PATCH /cats/:id`:
    + В теле запроса передаются поля, которые нужно обновить.

    + Обновление должно происходить частично (не все поля обязательны).

    + Если id не существует — вернуть `404 Not Found`.
  
4. DTO для обновления:
    + Создайте файл `update-cat.dto.ts` в папке `dto`. Все поля (`name, age, breed`) должны быть опциональными (`@IsOptional()`).

## Теория

**REST (Representational State Transfer)** — это архитектурный стиль взаимодействия между клиентом и сервером через HTTP. Каждый ресурс (например, "кошка") имеет свой URL и обрабатывается определёнными HTTP-методами:

| Метод | Назначение | Пример |
|-----------|-----------|-----------|
| GET | Получить данные | /cats или /cats/:id |
| POST | Создать ресурс | /cats |
| PATCH | Частично обновить | /cats/:id |
| DELETE | Удалить  ресурс | /cats/:id |

**HTTP-статусы**:

+ 200 OK — успешный запрос.

+ 201 Created — ресурс успешно создан.

+ 204 No Content — ресурс удалён, тело ответа не требуется.

+ 404 Not Found — запрашиваемый ресурс не найден.

+ 409 Conflict — конфликт.

**Основные файлы NestJS-модуля cats:**

1. `cats.controller.ts` - обрабатывает входящие HTTP-запросы и направляет их в сервис. Здесь описаны эндпоинты: GET, POST, PATCH, DELETE.
2. `cats.service.ts` - содержит бизнес-логику и взаимодействие с базой данных. Контроллер вызывает его методы.
3. `cats.module.ts` - описывает модуль NestJS: какие контроллеры, сервисы и сущности подключаются.
4. `dto/create-cat.dto.ts` - DTO (Data Transfer Object) для создания новой кошки. Здесь задаются поля и их валидация.
5. `entities/cat.entity.ts` - описание таблицы в базе данных (@Entity). Содержит поля id, name, age, breed.


## Требования

Перед началом убедитесь, что у вас установлены следующие инструменты:

- [Docker](https://www.docker.com/)
- [Docker Compose](https://docs.docker.com/compose/)

## Запуск приложения локально

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/MikhailovAlexander/construct-tasks.git
   cd construct-tasks
   ```

2. В файле `.env.local` указаны настройки приложения и базы данных.
3. Приложение запускается в докере:
    
    ```bash
    docker-compose -f docker-compose.local.yml --env-file .env.local up -d
    ```

4. Доступ к приложению:
    - Swagger для приложения будет доступно по адресу: http://localhost:3000/api
    - Менеджер базы данных pgAdmin будет доступен по адресу: http://localhost:5050, для входа нужно использовать параметры из файла `.env.local`, а также:
        * Email: admin@local.com
        * Password: admin
    
Для остановки контейнеров выполните:

```bash
docker-compose -f docker-compose.local.yml --env-file .env.local down
```

Для остановки контейнеров и удаления всех данных (volumes) выполните:

```bash
docker-compose -f docker-compose.local.yml --env-file .env.local down -v
```

## Тестирование проекта

В проекте настроены интеграционные тесты, которые проверяют работу REST API в связке с базой данных. Тесты позволяют убедиться, что приложение работает корректно, включая взаимодействие с базой данных.

### Организация тестов

1. **Интеграционные тесты**:
   - Тесты проверяют работу REST API в связке с базой данных.
   - Для выполнения тестов должна быть запущена база данных.

2. **Изоляция тестовой базы данных**:
   - Чтобы тесты не повлияли на основную базу данных приложения, для тестов всегда создается отдельная база данных.
   - Перед выполнением тестов база данных создается, а после выполнения тестов — удаляется.
   - Это поведение реализовано в следующих файлах:
     - `test/setup.ts` — выполняется перед запуском всех тестов, создает тестовую базу данных.
     - `test/teardown.ts` — выполняется после завершения всех тестов, удаляет тестовую базу данных.

3. **Контекст для тестов**:
   - В файле `test/context/context.ts` подготовлен контекст, который позволяет:
     - Собрать приложение для тестирования.
     - Подключиться к тестовой базе данных.
     - Полностью очищать базу данных перед выполнением каждого набора тестов.

4. **Примеры тестов**:
   - Примеры тестов расположены в файле `test/test-cats/get-cats.spec.ts`.
   - Этот файл содержит набор тестов для проверки GET-запросов к ресурсу `cats`.
   - Тесты сгруппированы в два раздела, с помощью `describe`:
     - **'Read all cats'** — проверяет запрос всех объектов.
     - **'Read one cat'** — проверяет запрос конкретного объекта по его идентификатору.
   - В тестах проверяется как успешное получение данных, так и обработка ошибок (например, запрос сущности, которой нет в базе данных).
   - В наборе тестов есть методы `beforeAll` и `beforeEach`, выполняемые перед запусков всех тестов и каждого теста этого набора тестов соответственно. В методе `beforeEach` происходит очистка таблицы базы данных проверяемой сущности, чтобы выполняемые тесты не зависели друг от друга.
   - В тесте, при необходимости можно создать в базе данных экземпляры проверяемой сущности, через вызов методов `contextService`.

### Запуск тестов

Для запуска тестов есть несколько вариантов:

1. **Через Docker**:
   - Запустите приложение и базу данных через Docker Compose:
     ```bash
     docker-compose -f docker-compose.local.yml --env-file .env.local up -d
     ```
   - Подключитесь к контейнеру с приложением:
     ```bash
     docker exec -it cats-app bash
     ```
   - Выполните команду для запуска тестов:
     ```bash
     npm run test
     ```

2. **Локально через Node.js**:
   - Убедитесь, что на вашей машине установлены Node.js и все необходимые пакеты (выполните `npm install`).
   - Запустите базу данных через Docker Compose:
     ```bash
     docker-compose -f docker-compose.local.yml --env-file .env.local up -d
     ```
   - Запустите тесты командой:
     ```bash
     npm run test
     ```

3. **Через VS Code** Если вы используете IDE Visual Studio Code:
   - Установите расширение [Jest](https://marketplace.visualstudio.com/items?itemName=Orta.vscode-jest).
   - Запустите базу данных через Docker Compose:

     ```bash
     docker-compose -f docker-compose.local.yml --env-file .env.local up -d
     ```

  - Запустите тесты через меню Jest в боковой панели.

### Полезные команды

- **Остановка контейнеров после тестов**:
  ```bash
  docker-compose -f docker-compose.local.yml --env-file .env.local down
  ```